version: "3.8"

services:
  nemenkom:
    build:
      context: .
      dockerfile: Dockerfile.web-api
    ports:
      - "3333:3333"
    volumes:
      - ./services/database:/app/services/database
      - ./services/web:/app/services/web
      - ./secrets:/app/secrets:ro # Mount secrets as read-only
      - ./config.py:/app/config.py:ro # Mount config as read-only (not baked into image)
    environment:
      - FLASK_ENV=production
      - TZ=Europe/Vilnius
    restart: unless-stopped

  scraper:
    build:
      context: .
      dockerfile: Dockerfile.scraper
    volumes:
      - ./services/database:/app/services/database
      - ./secrets:/app/secrets:ro # Mount secrets as read-only
      - ./config.py:/app/config.py:ro # Mount config as read-only (not baked into image)
    environment:
      - TZ=Europe/Vilnius
      - PYTHONUNBUFFERED=1
      # Optional one-time forced re-parse on container start (bypasses HEAD skip).
      # Creates a sentinel file under services/database so it won't repeat on restarts.
      # - FORCE_PARSE_ON_START=1
    restart: unless-stopped

  scraper_pdf:
    build:
      context: .
      dockerfile: Dockerfile.scraper-pdf
    volumes:
      - ./services/database:/app/services/database
      - ./secrets:/app/secrets:ro # Mount secrets as read-only
      - ./config.py:/app/config.py:ro # Mount config as read-only (not baked into image)
    environment:
      - TZ=Europe/Vilnius
      - PYTHONUNBUFFERED=1
      # Optional one-time forced re-parse on container start (bypasses HEAD+hash skips).
      # Creates a sentinel file under services/database so it won't repeat on restarts.
      # - FORCE_PARSE_ON_START=1
    restart: unless-stopped

  calendar:
    build:
      context: .
      dockerfile: Dockerfile.calendar
    volumes:
      - ./services/database:/app/services/database
      - ./secrets:/app/secrets:ro # Mount secrets as read-only
      - ./config.py:/app/config.py:ro # Mount config as read-only (not baked into image)
    environment:
      - TZ=Europe/Vilnius
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
