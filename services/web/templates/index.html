<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nemenkom.lt atliekÅ³ surinkimo grafikas â€“ Google kalendorius (NemenÄinÄ—)</title>
    <meta name="description" content="Neoficialus Nemenkom.lt atliekÅ³ surinkimo grafiko kalendorius. Raskite iÅ¡veÅ¾imo datas pagal kaimÄ…/miestÄ…, gatvÄ™ ir namo numerÄ¯, ir prenumeruokite Google kalendorius (bendros, plastikas, stiklas)." />
    <meta property="og:title" content="Nemenkom.lt atliekÅ³ surinkimo grafikas â€“ Google kalendorius (NemenÄinÄ—)" />
    <meta property="og:description" content="Neoficialus Ä¯rankis, padedantis patogiai rasti Nemenkom.lt atliekÅ³ iÅ¡veÅ¾imo datas ir prenumeruoti Google kalendorius." />
    <meta property="og:type" content="website" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="top-header">
        <div class="top-header-content">
            <a href="https://github.com/eidmantas/nemenkom" target="_blank" rel="noopener noreferrer" class="top-header-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 6px;">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                Kodas (GitHub)
            </a>
            <a href="https://github.com/eidmantas" target="_blank" rel="noopener noreferrer" class="top-header-link">
                ğŸ’¬ Atsiliepimai / PraÅ¡ymai
            </a>
            <a href="/api-docs" class="top-header-link">
                ğŸ“– API Documentation
            </a>
        </div>
    </div>
    <div class="container">
        <header>
            <h1>Nemenkom.lt atliekÅ³ surinkimo grafikas</h1>
            <div class="hero">
                <p class="subtitle hero-lead">
                    Neoficialus bandymas padaryti patogÅ³ kalendoriÅ³ iÅ¡ NemenÄinÄ—s komunalininko (â€nemenkom.ltâ€œ) grafiko.
                </p>

                <div class="hero-actions">
                    <div class="hero-row">
                        <span class="hero-label">Galite naudoti Web KalendoriÅ³ arba Google kalendorius:</span>
                        <span class="hero-chips">
                            <span class="hero-chip hero-chip-bendros">Bendros</span>
                            <span class="hero-chip hero-chip-plastikas">Plastikas</span>
                            <span class="hero-chip hero-chip-stiklas">Stiklas</span>
                        </span>
                    </div>
                </div>

                <p class="subtitle subtitle-warning">
                    <strong>âš ï¸ Gali bÅ«ti daug klaidÅ³ â€” pasitikrinkite. âš ï¸</strong> </br>
                    Jei randate klaidÅ³, praÅ¡au praneÅ¡kite (kol kas per LinkedIn/GitHub <a href="https://github.com/eidmantas" target="_blank" rel="noopener noreferrer">@eidmantas</a>). VÄ—liau atsiras patogesnÄ— funkcija tam.
                </p>
            </div>
        </header>

        <div class="selection-section">
            <div class="cascading-selects">
                <div class="select-group" id="villageSelectGroup">
                    <label for="villageInput">Kaimas/Miestas:</label>
                    <div class="searchable-dropdown">
                        <input type="text" id="villageInput" placeholder="IeÅ¡koti kaimo..." autocomplete="off" 
                               oninput="filterVillages()" onfocus="showVillageDropdown()" onblur="hideVillageDropdown()"
                               onkeydown="handleVillageKeydown(event)">
                        <datalist id="villageList"></datalist>
                        <div id="villageDropdown" class="dropdown-list"></div>
                    </div>
                </div>
                
                <div class="select-group" id="streetSelectGroup" style="display: none;">
                    <label for="streetInput">GatvÄ—:</label>
                    <div class="searchable-dropdown">
                        <input type="text" id="streetInput" placeholder="IeÅ¡koti gatvÄ—s..." autocomplete="off"
                               oninput="filterStreets()" onfocus="showStreetDropdown()" onblur="hideStreetDropdown()"
                               onkeydown="handleStreetKeydown(event)">
                        <datalist id="streetList"></datalist>
                        <div id="streetDropdown" class="dropdown-list"></div>
                    </div>
        </div>

                <div class="select-group" id="houseNumberSelectGroup" style="display: none;">
                    <label for="houseNumberInput">Namo numeris:</label>
                    <div class="searchable-dropdown">
                        <input type="text" id="houseNumberInput" placeholder="IeÅ¡koti namo numerio..." autocomplete="off"
                               oninput="filterHouseNumbers()" onfocus="showHouseNumberDropdown()" onblur="hideHouseNumberDropdown()"
                               onkeydown="handleHouseNumberKeydown(event)">
                        <datalist id="houseNumberList"></datalist>
                        <div id="houseNumberDropdown" class="dropdown-list"></div>
                    </div>
                </div>
                </div>
            </div>

        <div class="main-content">
            <div class="calendar-panel">
                <h2>Kalendorius</h2>
                <div id="selectedLocation" class="selected-location">
                    <p>Pasirinkite kaimÄ…, gatvÄ™ ir namo numerÄ¯</p>
                </div>
                <div id="calendarLegend" class="calendar-legend"></div>
                <div id="calendarContainer" class="calendar-container">
                    <!-- Calendar will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
    <script>
        // State
        let currentVillage = '';
        let currentStreet = '';
        let currentHouseNumber = '';
        let villageHasStreets = false;
        let streetHasHouseNumbers = false;
        let isRestoring = false;
        
        // Data storage
        let allVillages = [];
        let allStreets = []; // array of { street, available_waste_types, bendros_requires_house_numbers }
        let allHouseNumbers = []; // array of { house_numbers, available_waste_types }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            (async () => {
                // Load villages first so URL restore can be deterministic (no polling/sleeps).
                await loadVillages();
                await restoreFromURL();
            })();
        });

        // Normalize Lithuanian characters to ASCII for search
        // Allows typing "Riese" to match "RieÅ¡Ä—"
        function normalizeLithuanian(text) {
            if (!text) return '';
            const mapping = {
                'Ä…': 'a', 'Ä': 'c', 'Ä™': 'e', 'Ä—': 'e',
                'Ä¯': 'i', 'Å¡': 's', 'Å³': 'u', 'Å«': 'u',
                'Å¾': 'z',
                'Ä„': 'A', 'ÄŒ': 'C', 'Ä˜': 'E', 'Ä–': 'E',
                'Ä®': 'I', 'Å ': 'S', 'Å²': 'U', 'Åª': 'U',
                'Å½': 'Z'
            };
            return text.replace(/[Ä…ÄÄ™Ä—Ä¯Å¡Å³Å«Å¾Ä„ÄŒÄ˜Ä–Ä®Å Å²ÅªÅ½]/g, char => mapping[char] || char);
        }

        // Partial match function - matches if query appears anywhere in the string
        // Supports Lithuanian character normalization (typing "Riese" matches "RieÅ¡Ä—")
        function partialMatch(query, text) {
            if (!query) return true;
            const normalizedQuery = normalizeLithuanian(query.toLowerCase().trim());
            const normalizedText = normalizeLithuanian(text.toLowerCase());
            return normalizedText.includes(normalizedQuery);
        }

        async function loadVillages() {
            try {
                const response = await fetch('/api/v1/villages');
                const data = await response.json();
                allVillages = data.villages || []; // Array of {seniunija, village} objects
                populateVillageDatalist();
                return true;
            } catch (error) {
                console.error('Error loading villages:', error);
                return false;
            }
        }

        function populateVillageDatalist() {
            const datalist = document.getElementById('villageList');
            datalist.innerHTML = '';
            allVillages.forEach(v => {
                const option = document.createElement('option');
                const displayValue = `${v.seniunija} / ${v.village}`;
                option.value = displayValue;
                datalist.appendChild(option);
            });
        }

        function filterVillages() {
            const input = document.getElementById('villageInput');
            const query = input.value;
            const dropdown = document.getElementById('villageDropdown');
            
            let filtered;
            if (!query) {
                // Show all villages when no query
                filtered = allVillages;
            } else {
                // Filter by query - match either Seniunija or Village part
                filtered = allVillages.filter(v => {
                    const displayText = `${v.seniunija} / ${v.village}`;
                    return partialMatch(query, displayText) || 
                           partialMatch(query, v.seniunija) || 
                           partialMatch(query, v.village);
                });
            }
            
            dropdown.innerHTML = '';
            
            if (filtered.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Show all filtered results (scrollable)
            filtered.forEach(v => {
                const item = document.createElement('div');
                const displayText = `${v.seniunija} / ${v.village}`;
                item.className = 'dropdown-item dropdown-item-with-chips';

                const wasteTypes = v.available_waste_types || [];
                const scopes = v.waste_type_scopes || {};
                const chips = wasteTypes
                    .map(wt => {
                        const scope = scopes[wt] || 'some';
                        const extraClass = scope === 'some' ? ' waste-chip-partial' : '';
                        const title =
                            scope === 'all'
                                ? 'Galioja visam kaimui/miestui'
                                : 'Yra Å¡iame kaime/mieste (gali bÅ«ti ne visose gatvÄ—se)';
                        return `<span class="waste-chip waste-chip-${wt}${extraClass}" title="${title}">${wt}</span>`;
                    })
                    .join('');

                item.innerHTML = `
                    <span class="dropdown-item-text">${displayText}</span>
                    <span class="dropdown-item-chips">${chips}</span>
                `;
                item.onpointerdown = (e) => {
                    // On mobile, pointerdown fires before input blur; this avoids lost taps.
                    e.preventDefault();
                    input.value = displayText;
                    dropdown.style.display = 'none';
                    handleVillageSelection(v);
                };
                dropdown.appendChild(item);
            });
            
            dropdown.style.display = 'block';
        }

        function showVillageDropdown() {
            // Always show dropdown when focused, even if empty
            filterVillages();
        }

        function hideVillageDropdown() {
            // Delay to allow click events to fire
            setTimeout(() => {
                document.getElementById('villageDropdown').style.display = 'none';
            }, 200);
        }

        function handleVillageKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('villageInput');
                const query = input.value.trim();
                if (query) {
                    // Find first match - check full string or individual parts
                    const match = allVillages.find(v => {
                        const displayText = `${v.seniunija} / ${v.village}`;
                        return partialMatch(query, displayText) || 
                               partialMatch(query, v.seniunija) || 
                               partialMatch(query, v.village);
                    });
                    if (match) {
                        input.value = `${match.seniunija} / ${match.village}`;
                        document.getElementById('villageDropdown').style.display = 'none';
                        handleVillageSelection(match);
                    }
                }
            }
        }

        async function handleVillageSelection(villageObj, opts = {}) {
            const skipURLUpdate = !!opts.skipURLUpdate;
            // Reset state
            currentVillage = villageObj; // Store the object {seniunija, village}
            currentStreet = '';
            currentHouseNumber = '';
            villageHasStreets = false;
            streetHasHouseNumbers = false;
            
            // Clear street and house number inputs
            document.getElementById('streetInput').value = '';
            document.getElementById('houseNumberInput').value = '';
            
            // Hide street and house number selects
            document.getElementById('streetSelectGroup').style.display = 'none';
            document.getElementById('houseNumberSelectGroup').style.display = 'none';
            clearCalendar();
            
            // Update URL
            if (!skipURLUpdate) updateURL();
            
            if (!villageObj || !villageObj.seniunija || !villageObj.village) {
                return;
            }
            
            // Load streets for this village
            try {
                const response = await fetch(`/api/v1/streets?seniunija=${encodeURIComponent(villageObj.seniunija)}&village=${encodeURIComponent(villageObj.village)}`);
                const data = await response.json();
                const streets = data.streets || [];
                // Backward compatible: allow string[] or object[]
                allStreets = streets.map(s => (typeof s === 'string'
                    ? { street: s, available_waste_types: [], bendros_requires_house_numbers: false }
                    : s
                ));
                
                const streetValues = allStreets.map(s => s.street);
                const hasWholeVillage = streetValues.includes('');
                const hasOtherStreets = streetValues.filter(s => s !== '').length > 0;
                
                // Track if village has streets (non-empty streets)
                villageHasStreets = hasOtherStreets;
                
                // Populate street datalist
                populateStreetDatalist();
                
                // If only whole village (no other streets), auto-select it
                if (hasWholeVillage && !hasOtherStreets) {
                    currentStreet = '';
                    document.getElementById('streetSelectGroup').style.display = 'none';
                    await loadHouseNumbers(villageObj, '');
                } else if (hasOtherStreets) {
                    // Show street select - DON'T show "Visiems" if there are specific streets
                    document.getElementById('streetSelectGroup').style.display = '';
                } else {
                    // No streets at all - can load schedule directly
                    document.getElementById('streetSelectGroup').style.display = 'none';
                    await loadSchedule(villageObj, null, null);
                }
            } catch (error) {
                console.error('Error loading streets:', error);
            }
        }

        function populateStreetDatalist() {
            const datalist = document.getElementById('streetList');
            datalist.innerHTML = '';
            // Only show specific streets, NOT "Visiems" if there are specific streets
            const streetsToShow = villageHasStreets
                ? allStreets.filter(s => s.street !== '')  // Filter out empty string if there are specific streets
                : allStreets;  // Show all (including empty) if no specific streets
            streetsToShow.forEach(entry => {
                const option = document.createElement('option');
                option.value = entry.street || 'Visiems (visas kaimas)';
                datalist.appendChild(option);
            });
        }

        function filterStreets() {
            const input = document.getElementById('streetInput');
            const query = input.value;
            const dropdown = document.getElementById('streetDropdown');
            
            let filtered;
            if (!query) {
                // Show all streets when no query
                filtered = allStreets;
            } else {
                // Filter by query
                filtered = allStreets.filter(entry => partialMatch(query, entry.street || 'Visiems'));
            }
            
            dropdown.innerHTML = '';
            
            if (filtered.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Show all filtered results (scrollable)
            filtered.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'dropdown-item dropdown-item-with-chips';

                const label = entry.street || 'Visiems (visas kaimas)';
                const wasteTypes = entry.available_waste_types || [];
                const chips = wasteTypes
                    // Show bendros even when it requires house buckets, but render it "disabled" with a hint.
                    .map(wt => {
                        const needsHouse = wt === 'bendros' && entry.bendros_requires_house_numbers;
                        const extraClass = needsHouse ? ' waste-chip-disabled' : '';
                        const title = needsHouse ? 'Reikia pasirinkti namo numerÄ¯ (bendros)' : '';
                        return `<span class="waste-chip waste-chip-${wt}${extraClass}" title="${title}">${wt}</span>`;
                    })
                    .join('');

                item.innerHTML = `
                    <span class="dropdown-item-text">${label}</span>
                    <span class="dropdown-item-chips">${chips}</span>
                `;

                item.onpointerdown = (e) => {
                    e.preventDefault();
                    input.value = entry.street || 'Visiems (visas kaimas)';
                    dropdown.style.display = 'none';
                    handleStreetSelection(entry.street || '');
                };
                dropdown.appendChild(item);
            });
            
            dropdown.style.display = 'block';
        }

        function showStreetDropdown() {
            // Always show dropdown when focused, even if empty
            filterStreets();
        }

        function hideStreetDropdown() {
            setTimeout(() => {
                document.getElementById('streetDropdown').style.display = 'none';
            }, 200);
        }

        function handleStreetKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('streetInput');
                const query = input.value.trim();
                if (query) {
                    // Find first match
                    const match = allStreets.find(s => partialMatch(query, s.street || 'Visiems'));
                    if (match !== undefined) {
                        input.value = match.street || 'Visiems (visas kaimas)';
                        document.getElementById('streetDropdown').style.display = 'none';
                        handleStreetSelection(match.street || '');
                    }
                }
            }
        }

        async function handleStreetSelection(street, opts = {}) {
            const skipURLUpdate = !!opts.skipURLUpdate;
            // Reset house number
            currentStreet = street;
            currentHouseNumber = '';
            streetHasHouseNumbers = false;
            
            // Clear house number input
            document.getElementById('houseNumberInput').value = '';
            
            // Hide house number select
            document.getElementById('houseNumberSelectGroup').style.display = 'none';
            clearCalendar();
            
            // Update URL
            if (!skipURLUpdate) updateURL();
            
            if (!currentVillage) {
                return;
            }

            // Load house numbers
            await loadHouseNumbers(currentVillage, street);
        }

        async function loadHouseNumbers(villageObj, street) {
            try {
                const response = await fetch(`/api/v1/house-numbers?seniunija=${encodeURIComponent(villageObj.seniunija)}&village=${encodeURIComponent(villageObj.village)}&street=${encodeURIComponent(street)}`);
                const data = await response.json();
                const houseNumbers = data.house_numbers || [];
                // Backward compatible: allow string[] or object[]
                allHouseNumbers = houseNumbers.map(h => (typeof h === 'string'
                    ? { house_numbers: h, available_waste_types: [] }
                    : h
                ));
                
                // Track if street has house numbers (non-empty house numbers)
                const bucketValues = allHouseNumbers.map(h => h.house_numbers);
                streetHasHouseNumbers = bucketValues.filter(h => h !== '').length > 0;
                
                // Populate house number datalist
                populateHouseNumberDatalist();
                
                // If no specific house numbers, hide select and auto-load schedule
                if (!streetHasHouseNumbers) {
                    currentHouseNumber = '';
                    document.getElementById('houseNumberSelectGroup').style.display = 'none';
                    loadSchedule(villageObj, street, null);
                } else {
                    // Show house number select
                    document.getElementById('houseNumberSelectGroup').style.display = '';
                }
            } catch (error) {
                console.error('Error loading house numbers:', error);
            }
        }

        function populateHouseNumberDatalist() {
            const datalist = document.getElementById('houseNumberList');
            datalist.innerHTML = '';
            
            // Always add "Visiems" option
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = streetHasHouseNumbers ? 'Kitiems numeriams' : 'Visiems';
            datalist.appendChild(allOption);
            
            // Add specific house numbers
            allHouseNumbers.filter(h => h.house_numbers !== '').forEach(entry => {
                const option = document.createElement('option');
                option.value = entry.house_numbers;
                option.textContent = entry.house_numbers;
                datalist.appendChild(option);
            });
        }

        function filterHouseNumbers() {
            const input = document.getElementById('houseNumberInput');
            const query = input.value;
            const dropdown = document.getElementById('houseNumberDropdown');
            
            let filtered;
            if (!query) {
                // Show all house numbers when no query
                filtered = allHouseNumbers;
            } else {
                // Filter by query
                filtered = allHouseNumbers.filter(entry => partialMatch(query, entry.house_numbers || 'Visiems'));
            }
            
            dropdown.innerHTML = '';
            
            if (filtered.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Show all filtered results (scrollable)
            filtered.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'dropdown-item dropdown-item-with-chips';

                const label = entry.house_numbers || (streetHasHouseNumbers ? 'Kitiems numeriams' : 'Visiems');
                const wasteTypes = entry.available_waste_types || [];
                const chips = wasteTypes
                    .map(wt => `<span class="waste-chip waste-chip-${wt}">${wt}</span>`)
                    .join('');

                item.innerHTML = `
                    <span class="dropdown-item-text">${label}</span>
                    <span class="dropdown-item-chips">${chips}</span>
                `;

                item.onpointerdown = (e) => {
                    e.preventDefault();
                    input.value = entry.house_numbers || (streetHasHouseNumbers ? 'Kitiems numeriams' : 'Visiems');
                    dropdown.style.display = 'none';
                    handleHouseNumberSelection(entry.house_numbers || '');
                };
                dropdown.appendChild(item);
            });
            
            dropdown.style.display = 'block';
        }

        function showHouseNumberDropdown() {
            // Always show dropdown when focused, even if empty
            filterHouseNumbers();
        }

        function hideHouseNumberDropdown() {
            setTimeout(() => {
                document.getElementById('houseNumberDropdown').style.display = 'none';
            }, 200);
        }

        function handleHouseNumberKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('houseNumberInput');
                const query = input.value.trim();
                if (query) {
                    // Find first match
                    const match = allHouseNumbers.find(h => partialMatch(query, h.house_numbers || 'Visiems'));
                    if (match !== undefined) {
                        input.value = match.house_numbers || (streetHasHouseNumbers ? 'Kitiems numeriams' : 'Visiems');
                        document.getElementById('houseNumberDropdown').style.display = 'none';
                        handleHouseNumberSelection(match.house_numbers || '');
                    }
                }
            }
        }

        function handleHouseNumberSelection(houseNumber, opts = {}) {
            const skipURLUpdate = !!opts.skipURLUpdate;
            currentHouseNumber = houseNumber;
            
            if (!currentVillage || currentStreet === null || currentStreet === undefined) {
                return;
            }
            
            // Update URL
            if (!skipURLUpdate) updateURL();
            
            loadSchedule(currentVillage, currentStreet, houseNumber);
        }

        // Update URL with current selections
        function updateURL(opts = {}) {
            if (isRestoring) return;
            const replace = !!opts.replace;
            const params = new URLSearchParams();
            if (currentVillage && currentVillage.seniunija && currentVillage.village) {
                params.set('seniunija', currentVillage.seniunija);
                params.set('village', currentVillage.village);
            }
            if (currentStreet) {
                params.set('street', currentStreet);
            }
            if (currentHouseNumber) {
                params.set('house', currentHouseNumber);
            }
            
            const newURL = params.toString() 
                ? `${window.location.pathname}?${params.toString()}`
                : window.location.pathname;
            
            // Update URL without page reload (using history API)
            if (replace) {
                window.history.replaceState({}, '', newURL);
            } else {
                window.history.pushState({}, '', newURL);
            }
        }

        // Restore selections from URL on page load
        async function restoreFromURL() {
            const params = new URLSearchParams(window.location.search);
            const seniunija = params.get('seniunija');
            const village = params.get('village');
            const street = params.get('street');
            const house = params.get('house');
            
            if (!seniunija || !village) {
                return; // No URL parameters, start fresh
            }

            // If villages failed to load, restore can't proceed reliably.
            if (!allVillages || allVillages.length === 0) {
                return;
            }

            isRestoring = true;
            
            // Find matching village object
            const villageObj = allVillages.find(v => v.seniunija === seniunija && v.village === village);
            if (villageObj) {
                document.getElementById('villageInput').value = `${villageObj.seniunija} / ${villageObj.village}`;
                await handleVillageSelection(villageObj, { skipURLUpdate: true });
                
                // Set street if provided
                if (street !== null && allStreets.some(s => s.street === street)) {
                    document.getElementById('streetInput').value = street || 'Visiems (visas kaimas)';
                    await handleStreetSelection(street, { skipURLUpdate: true });
                    
                    // Set house number if provided
                    if (house !== null && allHouseNumbers.some(h => h.house_numbers === house)) {
                        document.getElementById('houseNumberInput').value = house;
                        handleHouseNumberSelection(house, { skipURLUpdate: true });
                    }
                }
            }

            // Write the final restored URL once, without polluting browser history.
            isRestoring = false;
            updateURL({ replace: true });
        }

        async function loadSchedule(villageObj, street, houseNumber) {
            try {
                const params = new URLSearchParams();
                params.append('seniunija', villageObj.seniunija);
                params.append('village', villageObj.village);
                
                // Only include street parameter if village has streets
                if (villageHasStreets && street !== null && street !== undefined) {
                    params.append('street', street);
                }
                // If village doesn't have streets, don't send street parameter at all
                
                // Only include house_numbers parameter if street has house numbers
                if (streetHasHouseNumbers && houseNumber) {
                    params.append('house_numbers', houseNumber);
                }
                // If street doesn't have house numbers, don't send house_numbers parameter at all
                
                const response = await fetch(`/api/v1/schedule-multi?${params.toString()}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Klaida: ' + data.error);
                    return;
                }

                displaySelectedLocationMulti(data, houseNumber);
                renderLegend(data.available_waste_types || []);
                renderCalendar(data.dates || []);
            } catch (error) {
                console.error('Error loading schedule:', error);
                alert('Klaida kraunant grafikÄ…');
            }
        }

        function displaySelectedLocationMulti(payload, houseNumber) {
            const container = document.getElementById('selectedLocation');
            const selection = payload.selection || {};
            const schedules = payload.schedules || {};
            const availableWasteTypes = payload.available_waste_types || [];

            const streetDisplay = selection.street || '(visas kaimas)';
            const needsBuckets = !!payload.bendros_requires_house_numbers;
            const houseDisplay = houseNumber
                ? ` - ${houseNumber}`
                : (needsBuckets ? ' - Kitiems numeriams' : ' - Visiems');
            // Seniunija is already shown in the village selection, so we don't need to show it again
            const displayName = `${selection.village} - ${streetDisplay}${houseDisplay}`;

            const labelMap = {
                bendros: 'Bendros',
                plastikas: 'Plastikas',
                stiklas: 'Stiklas',
            };

            const schedBlocks = availableWasteTypes.map(wt => {
                const sched = schedules[wt];
                if (!sched) {
                    return `
                        <div class="schedule-row">
                            <div class="schedule-row-title">${labelMap[wt] || wt}</div>
                            <div class="schedule-row-status">NÄ—ra duomenÅ³</div>
                        </div>
                    `;
                }

                const status = (sched.calendar_status && sched.calendar_status.status) || 'not_available';
                const subscriptionLink = sched.subscription_link;
                const datesCount = (sched.dates || []).length;

                let actionHtml = '';
                if (status === 'synced' && subscriptionLink) {
                    actionHtml = `<a href="${subscriptionLink}" target="_blank" rel="noopener noreferrer" class="calendar-subscribe-button small">Prenumeruoti</a>`;
                } else if (status === 'pending') {
                    actionHtml = `<span class="calendar-status-pill pending">Kuriamas</span>`;
                } else if (status === 'needs_update') {
                    actionHtml = `<span class="calendar-status-pill needs-update">Atnaujinamas</span>`;
                } else {
                    actionHtml = `<span class="calendar-status-pill not-available">NÄ—ra</span>`;
                }

                return `
                    <div class="schedule-row">
                        <div class="schedule-row-title">${labelMap[wt] || wt}</div>
                        <div class="schedule-row-meta">${datesCount} d.</div>
                        <div class="schedule-row-action">${actionHtml}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <h3>${displayName}</h3>
                <div class="schedule-list">
                    ${schedBlocks}
                </div>
            `;
        }

        function clearCalendar() {
            document.getElementById('calendarContainer').innerHTML = '';
            document.getElementById('selectedLocation').innerHTML = '<p>Pasirinkite kaimÄ…, gatvÄ™ ir namo numerÄ¯</p>';
            document.getElementById('calendarLegend').innerHTML = '';
        }

    </script>
</body>
</html>
